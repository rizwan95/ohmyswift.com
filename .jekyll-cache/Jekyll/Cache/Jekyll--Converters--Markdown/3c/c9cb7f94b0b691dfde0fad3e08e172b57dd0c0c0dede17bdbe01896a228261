I"!<p>We all love WebSockets, don’t we? They have a vast range of applications such as chat applications, push notifications, and much more. I got excited when I stumbled upon 
“URLSessionWebSocketTask”. That’s right, in addition to data task, download task, and upload task, we have websocketTask! in URLSession. Websockets are now first-class citizens in the foundation framework. Before websocket tasks, we had to use third-party libraries like Star Scream or Socket Rocket, but it is not the case anymore.</p>

<div>
    <a class="notification sponsor" href="https://winya.app/get?utm_source=ohmyswift&amp;utm_medium=appshowcase-mini&amp;utm_campaign=may" target="_blank">
    <img src="https://winya.app/assets/img/winya-squircle.png" />
    <div>
    <p class="sponsor-title">
        Winya: Live Stream Games
    </p>
    <p>
        Become a Streamer by starting a live stream from your iPhone/iPad to Twitch/YouTube or any live streaming service of your choice. Download the app and become a creator now!</p>
    </div>
</a>
</div>

<p><img src="/blog/assets/images/websockettask.jpg" alt="Socket connection in Swift" /></p>

<p>Let’s see how we can implement it in our project(s). 
I have created a separate class named “WebSocketConnector,” which acts as a socket connection manager/handler where all the socket related code is present.</p>

<p>URLSessionWebSocketTask is an extension of URLSessionTask.</p>

<p>We first have to create a urlsession object. The urlsession object has a method called as “websocketTask(with: URL)” using which we can create a websocket task. 
The websocketTask method takes a socket URL as a parameter. For the demo, we are going to use “wss://echo.websocket.org” to test our socket connection.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="nf">init</span><span class="p">(</span><span class="n">withSocketURL</span> <span class="nv">url</span> <span class="p">:</span> <span class="kt">URL</span><span class="p">){</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="n">urlSession</span>  <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="n">operationQueue</span><span class="p">)</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="n">urlSession</span><span class="o">.</span><span class="nf">webSocketTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
    <span class="p">}</span></code></pre></figure>

<p>I have created a WebSocketProtocol and our  WebSocketConnector confroms to it. We implement the “establishConnection()” method, disconnect method, and send methods.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">establishConnection</span><span class="p">(){</span>
        <span class="n">socket</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="nf">addListener</span><span class="p">()</span>
    <span class="p">}</span></code></pre></figure>

<p>In the “establishConnection” method, we call the “resume()” method on the socket and add a listener to the socket. The “addListener()” method gets invoked whenever the app receives a message or an error from the server.</p>

<p>After establishing a connection,  we can send a message or data to the server. As the server which we use is an echo server, it gives you back the message which you send.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift">    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">addListener</span><span class="p">(){</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">receive</span> <span class="p">{[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">response</span><span class="p">):</span>
                <span class="k">switch</span> <span class="n">response</span> <span class="p">{</span>
                    
                <span class="k">case</span> <span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="k">let</span> <span class="nv">data</span><span class="p">):</span>
                    <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveData</span><span class="p">?(</span><span class="n">data</span><span class="p">)</span>

                <span class="k">case</span> <span class="o">.</span><span class="nf">string</span><span class="p">(</span><span class="k">let</span> <span class="nv">message</span><span class="p">):</span>
                    <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveMessage</span><span class="p">?(</span><span class="n">message</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveError</span><span class="p">?(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">message</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">socket</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="kt">URLSessionWebSocketTask</span><span class="o">.</span><span class="kt">Message</span><span class="o">.</span><span class="nf">string</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="p">{[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">didReceiveError</span><span class="p">?(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<p>So whenever a successful message is received, the “didReceiveMessage?(message)” is triggered. When an error is received, the “didReceiveError?(error)” is invoked.</p>

<p>When we need to close the connection, we call the “disconnect()” method. Simple, isn’t it?</p>

<p>I enjoyed implementing it, and it is a great relief that Apple provided us native WebSocket support. However, we still have to rely on third-party libraries if we are supporting iOS 12 and below. If your deployment target is 13.0 and above, you can go with “URLSessionWebSocketTask” without any hesitations.</p>

<p>You can find the completed project <a href="https://github.com/rizwan95/SwiftWebSockets">here</a>.
I am excited to see you people implement URLSessionWebSocketTask in your projects. Do share your experience and of course, if you have any questions, ask them in the comments. You can also reach out to me directly on <a href="https://twitter.com/rizwanasifahmed">Twitter</a></p>

:ET