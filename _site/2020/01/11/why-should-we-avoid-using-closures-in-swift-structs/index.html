<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  
    
    
    
    <title>Why should we avoid using closures in Swift structs?</title>
    <meta name="description" content="We all love closures, don’t we? Closures make an iOS developer’s life easy. Well, if it makes it easy, then why am I saying to avoid using closures in Swift structs? The reason is, “Memory leaks and unexpected behaviors.” Wait. What? Memory leak in structs? How could that be possible?">
    
  
    <link rel="stylesheet" href="/blog/assets/main.css">
    <link rel="canonical" href="http://localhost:4000/blog/2020/01/11/why-should-we-avoid-using-closures-in-swift-structs/">
    
    
    <link rel="alternate" type="application/rss+xml" title="Oh my Swift" href="http://localhost:4000/blog/feed.xml">
  
    
  
    
    <meta property="og:title" content="Why should we avoid using closures in Swift structs?">
    <meta property="og:site_name" content="Oh my Swift">
    <meta property="og:url" content="http://localhost:4000/blog/2020/01/11/why-should-we-avoid-using-closures-in-swift-structs/">
    <meta property="og:description" content="We all love closures, don’t we? Closures make an iOS developer’s life easy. Well, if it makes it easy, then why am I saying to avoid using closures in Swift structs? The reason is, “Memory leaks and unexpected behaviors.” Wait. What? Memory leak in structs? How could that be possible?">
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="rizwanasifahmed">
    <meta name="twitter:title" content="Why should we avoid using closures in Swift structs?">
    <meta name="twitter:description" content="We all love closures, don’t we? Closures make an iOS developer’s life easy. Well, if it makes it easy, then why am I saying to avoid using closures in Swift structs? The reason is, “Memory leaks an...">
    
      <meta name="twitter:creator" content="rizwanasifahmed">
    
    
  
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700&display=swap" rel="stylesheet">

    
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-144905716-1', 'auto');
    ga('send', 'pageview');

  </script>


    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Why should we avoid using closures in Swift structs? | Oh my Swift</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Why should we avoid using closures in Swift structs?" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="We all love closures, don’t we? Closures make an iOS developer’s life easy. Well, if it makes it easy, then why am I saying to avoid using closures in Swift structs? The reason is, “Memory leaks and unexpected behaviors.” Wait. What? Memory leak in structs? How could that be possible?" />
<meta property="og:description" content="We all love closures, don’t we? Closures make an iOS developer’s life easy. Well, if it makes it easy, then why am I saying to avoid using closures in Swift structs? The reason is, “Memory leaks and unexpected behaviors.” Wait. What? Memory leak in structs? How could that be possible?" />
<link rel="canonical" href="http://localhost:4000/blog/2020/01/11/why-should-we-avoid-using-closures-in-swift-structs/" />
<meta property="og:url" content="http://localhost:4000/blog/2020/01/11/why-should-we-avoid-using-closures-in-swift-structs/" />
<meta property="og:site_name" content="Oh my Swift" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-11T10:06:00+05:30" />
<script type="application/ld+json">
{"url":"http://localhost:4000/blog/2020/01/11/why-should-we-avoid-using-closures-in-swift-structs/","headline":"Why should we avoid using closures in Swift structs?","dateModified":"2020-01-11T10:06:00+05:30","datePublished":"2020-01-11T10:06:00+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/2020/01/11/why-should-we-avoid-using-closures-in-swift-structs/"},"description":"We all love closures, don’t we? Closures make an iOS developer’s life easy. Well, if it makes it easy, then why am I saying to avoid using closures in Swift structs? The reason is, “Memory leaks and unexpected behaviors.” Wait. What? Memory leak in structs? How could that be possible?","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@rizwanasifahmed">
  <meta name="twitter:creator" content="@">
  <meta name="twitter:title"   content="Why should we avoid using closures in Swift structs?">

  
  <meta name="twitter:description" content="Ohmyswift.com focuses on delivering latest articles about Swift and iOS development.">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content="">
  
  <!-- end of Twitter cards -->


</head>
  

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Oh my Swift</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/blog/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/rizwan95">GitHub</a>
      
        
        <a class="page-link" href="https://twitter.com/rizwanasifahmed">Twitter</a>
      
        
        <a class="page-link" href="https://www.reddit.com/r/ohmyswift/">Reddit</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Why should we avoid using closures in Swift structs?</h1>
    
    <p class="post-meta"><time datetime="2020-01-11T10:06:00+05:30" itemprop="datePublished">Jan 11, 2020</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/blog/categories/swift-struct-closures-struct-vs-classes/">Swift, Struct, Closures, struct vs classes</a>
      
    
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>We all love closures, don’t we? Closures make an iOS developer’s life easy. Well, if it makes it easy, then why am I saying to avoid using closures in Swift structs? The reason is, “Memory leaks and unexpected behaviors.”
Wait. What? Memory leak in structs? How could that be possible?</p>

<p><img src="/blog/assets/images/closuresinstructs.png" alt="Why should we avoid using closures in Swift structs?" /></p>

<p>Structs are value types, and there is no way a memory leak can occur.
Is that statement even true? We have so many questions already. So let’s get back to the basics of memory management in Swift.</p>

<h2 id="back-to-basics"><strong>Back to basics</strong></h2>

<p>The reason I am taking you back to the basics is that before diving into the main problem, we need to have a stronghold of the basics.</p>

<p>The basic types in Swift fall into two categories. One is the “Reference type,” and the other is the “Value type.” Generally, Classes are reference types. On the other hand, structs and enums are value types.</p>

<h2 id="value-types"><strong>Value types</strong></h2>

<p>The value types store the data directly in memory. Every instance has a unique copy of the data. When a variable is assigned to an existing variable, the data is copied. The allocation of the value types is done in the stack. When the value type variable goes out of scope, the deallocation of the memory occurs.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Person</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">name</span> <span class="p">:</span> <span class="kt">String</span>
<span class="p">}</span>
<span class="k">var</span> <span class="nv">oldPerson</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Rizwan"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">newPerson</span> <span class="o">=</span> <span class="n">oldPerson</span>
<span class="n">newPerson</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Oh my Swift"</span>
<span class="nf">print</span><span class="p">(</span><span class="n">oldPerson</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">newPerson</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="o">-------</span>
<span class="kt">Output</span><span class="p">:</span>
<span class="kt">Rizwan</span>
<span class="kt">Oh</span> <span class="n">my</span> <span class="kt">Swift</span>
<span class="o">-------</span>
</code></pre></div></div>

<p>We can see that changing the value of the newPerson doesn’t change the value of oldPerson. This is how value types work.</p>

<h2 id="reference-types"><strong>Reference types</strong></h2>

<p>The reference types keep a reference (aka a pointer) to the data when initialized. Whenever a variable is assigned to an existing reference type, the reference is shared among the variables. The allocation of reference types is done in the heap. The ARC (Automatic Reference Counting) handles the deallocation of the reference type variables.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">Person</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    <span class="nf">init</span><span class="p">(</span><span class="n">withName</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">){</span>
        <span class="k">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">var</span> <span class="nv">oldPerson</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"Rizwan"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">newPerson</span> <span class="o">=</span> <span class="n">oldPerson</span>
<span class="n">newPerson</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Oh my Swift"</span>
<span class="nf">print</span><span class="p">(</span><span class="n">oldPerson</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">newPerson</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="o">------</span>
<span class="kt">Output</span>
<span class="kt">Oh</span> <span class="n">my</span> <span class="kt">Swift</span>
<span class="kt">Oh</span> <span class="n">my</span> <span class="kt">Swift</span>
<span class="o">------</span>
</code></pre></div></div>

<p>We can see that changing the oldPerson variable reflects the changes in the newPerson variable. This is how reference types work.</p>

<p>Usually, memory leaks occur in reference types. It occurs in the form of retain cycles in most of the cases. To know more about retain cycles, read this <a href="https://medium.com/flawless-app-stories/memory-leaks-in-swift-bfd5f95f3a74">blog</a> from Flawless app stories.</p>

<p>So, if reference types are the reason for memory leaks, we can use value types for all purposes. That should solve the problem.</p>

<p>Unfortunately, this is not the case. Sometimes structs and enums can be treated as reference types, and this means that retain cycles can occur in structs and enums too.</p>

<h2 id="closures---the-villain-in-structs"><strong>Closures - The Villain in structs</strong></h2>

<p>When you use closures in structs, the closure behaves as a reference type, and the problem starts there. The closures need to have a reference to the environment outside so that the environment can be modified when the closure body is executed.</p>

<p>In the case of classes, we can use <code class="highlighter-rouge">weak self</code> to break the retain cycle. When we try to do it for a struct, we get the following compiler error, ‘weak’ may only be applied to class and class-bound protocol types, not ‘{struct name}’</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Car</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">speed</span><span class="p">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">var</span> <span class="nv">increaseSpeed</span><span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">())?</span>
<span class="p">}</span>
<span class="k">var</span> <span class="nv">myCar</span> <span class="o">=</span> <span class="kt">Car</span><span class="p">()</span>
<span class="n">myCar</span><span class="o">.</span><span class="n">increaseSpeed</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">myCar</span><span class="o">.</span><span class="n">speed</span> <span class="o">+=</span> <span class="mi">30</span> <span class="c1">// The retain cycle occurs here. We cannot use [weak myCar] as myCar is a value type.</span>
<span class="p">}</span>
<span class="n">myCar</span><span class="o">.</span><span class="nf">increaseSpeed</span><span class="p">?()</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"My car's speed :"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">myCar</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span> <span class="c1">// Prints 30</span>

<span class="k">var</span> <span class="nv">myNewCar</span> <span class="o">=</span> <span class="n">myCar</span>
<span class="n">myNewCar</span><span class="o">.</span><span class="nf">increaseSpeed</span><span class="p">?()</span>
<span class="n">myNewCar</span><span class="o">.</span><span class="nf">increaseSpeed</span><span class="p">?()</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"My new car's speed :"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">myNewCar</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span> <span class="c1">// Prints 30 still!</span>
</code></pre></div></div>

<p>You would have expected the result of myNewCar to be 90.0, but it prints My new car’s speed: 30.0</p>

<h2 id="but-why"><strong>But why?</strong></h2>

<p>Well, the reason is, “myNewCar” is a partial copy of “newCar.” Since closures and their environments cannot be copied completely. The value of “speed” is copied, but the property “increaseSpeed” of “myNewCar” (myNewCar.increaseSpeed?()) holds a reference to the “increaseSpeed” of “myCar” with the “speed” of “myCar” in the captured environment. So, the “increaseSpeed” of “myCar” is invoked.</p>

<p>These are the various reasons why closures in Swift structs are dangerous.</p>

<h2 id="so-what-do-we-do-now"><strong>So what do we do now?</strong></h2>

<p>The straight forward solution is, avoid using closures in value types. If you want to use them, you should be very careful with it, or else it might lead to unexpected results.
Regarding the retain cycle, the only way to break them is to set the variables “myCar” and “myNewCar” to nil manually. It doesn’t sound ideal, but there is no other way.</p>

<p>It was really thought provoking for me when I learnt about the behaviour of closures in value types. I hope you also felt the same.</p>

<p>Enjoyed reading it? Feel free to share your comments below. Like this article? Share it with your friends!
 You can also follow me on twitter right here: <a href="https://twitter.com/rizwanasifahmed">https://twitter.com/rizwanasifahmed</a></p>

<h2 id="references"><strong>References</strong></h2>

<p>[1] <a href="https://forums.swift.org/t/avoiding-unbreakable-reference-cycle-with-value-types-and-closures/18757/6">https://forums.swift.org/t/avoiding-unbreakable-reference-cycle-with-value-types-and-closures/18757/6</a></p>

<p>[2] <a href="https://github.com/Wolox/ios-style-guide/blob/master/rules/avoid-struct-closure-self.md">https://github.com/Wolox/ios-style-guide/blob/master/rules/avoid-struct-closure-self.md</a></p>

<p>[3] <a href="https://www.objc.io/issues/16-swift/swift-classes-vs-structs/">https://www.objc.io/issues/16-swift/swift-classes-vs-structs/</a></p>

<p>[4] <a href="https://marcosantadev.com/capturing-values-swift-closures/">https://marcosantadev.com/capturing-values-swift-closures/</a></p>

  </div>

  

</article>


<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ohmyswift.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            





      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy;  - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="http://localhost:4000/blog/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
